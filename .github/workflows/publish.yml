name: Publish

on:
  release:
    types: [created]

jobs:
  publish-vs-code:
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: extensions/vs-code/package-lock.json

    - name: Install dependencies
      working-directory: extensions/vs-code
      run: npm ci

    - name: Build VSIX package
      working-directory: extensions/vs-code
      run: |
        npm run compile
        npx vsce package

    - name: Publish to VS Code Marketplace
      working-directory: extensions/vs-code
      if: env.VSCE_PAT != ''
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
      run: npx vsce publish --pat $VSCE_PAT

    - name: Upload VSIX to release
      uses: softprops/action-gh-release@v1
      with:
        files: extensions/vs-code/socrates2.vsix
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-jetbrains:
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3

    - name: Build IntelliJ plugin
      working-directory: plugins/jetbrains
      run: gradle :intellij:buildPlugin

    - name: Build PyCharm plugin
      working-directory: plugins/jetbrains
      run: gradle :pycharm:buildPlugin

    - name: Build WebStorm plugin
      working-directory: plugins/jetbrains
      run: gradle :webstorm:buildPlugin

    - name: Publish to JetBrains Marketplace
      working-directory: plugins/jetbrains
      if: env.JETBRAINS_MARKETPLACE_TOKEN != ''
      env:
        JETBRAINS_MARKETPLACE_TOKEN: ${{ secrets.JETBRAINS_MARKETPLACE_TOKEN }}
      run: |
        gradle :intellij:publishPlugin \
          -Dorg.gradle.internal.publish.checksums.insecure=true \
          -PjetbrainsMarketplaceToken=$JETBRAINS_MARKETPLACE_TOKEN

    - name: Upload plugins to release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          plugins/jetbrains/intellij/build/distributions/*.zip
          plugins/jetbrains/pycharm/build/distributions/*.zip
          plugins/jetbrains/webstorm/build/distributions/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-lsp:
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel twine

    - name: Build LSP package
      working-directory: backend/lsp
      run: python setup.py sdist bdist_wheel

    - name: Publish to PyPI
      working-directory: backend/lsp
      if: env.PYPI_API_TOKEN != ''
      env:
        PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/* \
          --username __token__ \
          --password $PYPI_API_TOKEN \
          --non-interactive

    - name: Upload distributions to release
      uses: softprops/action-gh-release@v1
      with:
        files: backend/lsp/dist/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-github-release:
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    needs: [publish-vs-code, publish-jetbrains, publish-lsp]

    steps:
    - uses: actions/checkout@v4

    - name: Create release notes
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const changelog = fs.readFileSync('CHANGELOG.md', 'utf8');
          const version = context.ref.replace('refs/tags/', '');

          // Extract this version's changes from CHANGELOG
          const versionRegex = new RegExp(`## \\[${version}\\]([\\s\\S]*?)(?=## \\[|$)`);
          const match = changelog.match(versionRegex);
          const versionChanges = match ? match[1] : 'See CHANGELOG.md for details';

          github.rest.repos.updateRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: context.payload.release.id,
            body: `## Release ${version}\n\n${versionChanges}\n\n### Download\n- VS Code: Search "Socrates" in Extensions or install from VSIX\n- IntelliJ: Search "Socrates" in Plugins Marketplace\n- PyCharm: Search "Socrates" in Plugins Marketplace\n- WebStorm: Search "Socrates" in Plugins Marketplace\n- LSP: \`pip install socrates2-lsp\``
          });
